#!/bin/bash

[ -f "$(which tgpt)" ] || exit 1
[ -f "$(which whisper)" ] || exit 1
[ -f "$(which whiptail)" ] || exit 1
[ -f "$(which mpv)" ] || exit 1
[ -f "$(which arecord)" ] || exit 1
[ -f "$(which ffmpeg)" ] || exit 1

TERM=ansi
MINIMAL_MODE=false

audio_file="/tmp/vocalize.wav"
text_file="${audio_file%.wav}.txt"
enriched_transcription_file="${text_file%.txt}-enriched.txt"

cat <<EOF >/tmp/vocalize-prompt
Você é um redator de conteúdo especializado em reescrever textos de forma concisa e clara. Com anos de experiência na síntese de informações complexas, você se destaca em transformar transcrições longas em resumos informativos, mantendo a essência e os pontos principais do assunto.

Sua tarefa é receber uma transcrição de áudio e reescrevê-la de forma mais concisa. O texto refatorado deve ser apresentado de maneira direta, sem comentários ou explicações adicionais.

A transcrição do áudio será enviada para você na próxima mensagem. Certifique-se de entregar somente o texto refatorado e evite produzir qualquer resposta em caso de erro na transcrição. O texto reescrito deve estar em português do Brasil.

Por favor, deixe a seção abaixo em branco para que eu escreva a transcrição do áudio:
Transcrição do áudio:
EOF

play_audio() {
	clear
	printf "\033[8;40;100t"
	printf "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
	printf "\033[13C  ╔══════════════════════════╗\n"
	printf "\033[13C  ║     MPV Running...       ║\n"
	printf "\033[13C  ╚══════════════════════════╝\n"

	mpv --no-video --input-terminal=yes "$audio_file"
}

record_audio() {

	echo "Iniciando gravação do áudio. Pressione Cancel para interromper a gravação."
	arecord -f cd -t wav "$audio_file" >/dev/null 2>&1 &

	arecord_pid=$!

	whiptail --title "Gravação de Áudio" --yesno "A gravação está em andamento. Deseja salvar o áudio?" 10 50
	response=$?

	kill -SIGINT $arecord_pid

	# May God forgive this workaround
	mv "$audio_file" /tmp/aux.wav
	ffmpeg -i /tmp/aux.wav -ar 16000 "$audio_file"

	if [ $response -ne 0 ]; then
		echo "Gravação do áudio cancelada."
		rm -f "$audio_file"
		return 1
	fi

	return 0
}

save_audio() {
	file_name=$(whiptail --inputbox "Digite um nome para salvar o áudio:" 10 50 3>&1 1>&2 2>&3)

	if [ -z "$file_name" ]; then
		echo "Nome de arquivo inválido. Ação cancelada."
		return
	fi

	cp "$audio_file" "$HOME/$file_name.wav"
	echo "O arquivo foi copiado para: $HOME/$file_name"
}

open_transcribed_audio() {
	whiptail --title "Vocalize" --scrolltext --textbox "$text_file" 12 80
}

remove_transcribed_audio() {
	rm -f "$text_file"
	whiptail --title "Vocalize" --msgbox "Texto removido!" 12 80
}

save_transcribed_audio() {
	file_name=$(whiptail --inputbox "Digite um nome para salvar o arquivo:" 10 50 3>&1 1>&2 2>&3)

	if [ -z "$file_name" ]; then
		echo "Nome de arquivo inválido. Ação cancelada."
		return
	fi

	cp "$text_file" "$HOME/$file_name.txt"
	echo "O arquivo foi copiado para: $HOME/$file_name"
}

transcribe_audio() {
	whiptail --title "Vocalize" --infobox "Transcrevendo o audio, aguarde..." 12 80
	whisper -f "$audio_file" \
		-l pt \
		-np \
		-m ~/Packages/whisper.cpp/models/ggml-base.bin \
		-otxt \
		-of "${text_file%.txt}"
	[ "$MINIMAL_MODE" = false ] && open_transcribed_audio
}

copy_transcribed_audio_to_clipboard() {
	selected_file="$1"
	cat "${selected_file}" | xclip -selection clipboard
	if [ "$MINIMAL_MODE" = false ]; then
		whiptail --title "Vocalize" --msgbox "Texto copiado para a clipboard!" 12 80
		clear
	else
		clear
		echo "Texto copiado para a clipboard!"
	fi
}

enrich_transcription() {
	tgpt -q --preprompt "$(cat /tmp/vocalize-prompt)" "$(cat $text_file)" >$enriched_transcription_file
	[ "$MINIMAL_MODE" = false ] && whiptail --title "Vocalize" --scrolltext --textbox "$enriched_transcription_file" 12 80
}

record_and_transcribe() {
	if ! record_audio; then
		whiptail --title "Operação cancelada" --msgbox "A gravação foi cancelada." 12 80
		clear
		return 1
	fi
	transcribe_audio
	enrich_transcription
	copy_transcribed_audio_to_clipboard "${text_file%.txt}-enriched.txt"
}

cleanup_old_files() {
	rm -f "$audio_file"
	rm -f "$text_file"
	rm -f "$enriched_transcription_file"
}

# If called with no '-r' option, show all options
main_vocalize() {
	while true; do
		if [ -f "$audio_file" ] && [ ! -f "$text_file" ]; then
			menu_choices=("Gravar" "Excluir Áudio" "Ouvir" "Salvar" "Transcrever(experimental)")
		elif [ -f "$audio_file" ] && [ -f "$text_file" ]; then
			menu_choices=("Gravar" "Excluir Áudio" "Ouvir" "Salvar Áudio"
				"Abrir Transcrição(experimental)"
				"Salvar Transcrição(experimental)"
				"Excluir Transcrição(experimental)"
				"Copiar para a Clipboard(experimental)"
				"Melhorar texto com IA(experimental)"
			)
		else
			menu_choices=("Gravar")
		fi

		menu_options=()
		for choice in "${menu_choices[@]}"; do
			menu_options+=("$choice" "")
		done

		chosen_option=$(whiptail --title "Vocalize" --menu "Escolha uma opção:" 15 40 9 "${menu_options[@]}" 3>&1 1>&2 2>&3)

		case $chosen_option in
		"Gravar")
			record_audio
			;;
		"Excluir Áudio")
			rm -f "$audio_file"
			whiptail --title "Vocalize" --msgbox "Arquivo removido!" 12 80
			;;
		"Ouvir")
			play_audio
			;;
		"Salvar")
			save_audio
			;;
		"Abrir Transcrição(experimental)")
			open_transcribed_audio
			;;
		"Salvar Transcrição(experimental)")
			save_transcribed_audio
			;;
		"Copiar para a Clipboard(experimental)")
			copy_transcribed_audio_to_clipboard "$text_file"
			;;
		"Excluir Transcrição(experimental)")
			remove_transcribed_audio
			;;
		"Melhorar texto com IA(experimental)")
			enrich_transcription
			copy_transcribed_audio_to_clipboard "$enriched_transcription_file"
			;;
		"Transcrever(experimental)")
			transcribe_audio
			;;
		*)
			echo "Operação cancelada"
			clear
			break
			;;
		esac
	done
}

while getopts ":mti" opt; do
	case ${opt} in
	m)
		MINIMAL_MODE=true
		;;
	t)
		MINIMAL_MODE=true
		copy_transcribed_audio_to_clipboard "$text_file"
		exit 0
		;;
	i)
		MINIMAL_MODE=true
		copy_transcribed_audio_to_clipboard "$enriched_transcription_file"
		exit 0
		;;
	\?)
		echo "Uso: $0 [-m]"
		exit 1
		;;
	esac
done

cleanup_old_files
if [ "$MINIMAL_MODE" = true ]; then
	record_and_transcribe
else
	main_vocalize
fi
